# biliuwp_download / Bilibili UWP 缓存视频合并工具

> 💣本项目仅用于个人学习使用，请遵守 Bilibili 用户协议，尊重视频版权，**勿用于盗版或商业分发**。

## 😭 背景
Bilibili UWP 客户端下载的高清视频以 **DASH 分片**形式存储：
- 一个 `.m4s` 文件（视频流）
- 一个 `.m4s` 文件（音频流）
- 文件开头被添加了 **9 个 `0x30`（ASCII '0'）垃圾字节**，导致无法直接播放。

本工具一键将 Bilibili UWP 客户端缓存的 `.m4s` 分片视频 + 音频 合并为标准 MP4 文件，并自动使用视频标题命名。

---

## 📌 功能特点
- ✅ **安全无损**：绝不修改原始缓存文件（只读模式）
- ✅ **自动去“伪加密”头**：跳过 B站 UWP 添加的 9 字节垃圾头（`0x30 0x30 ...`）
- ✅ **智能文件名**：读取 `videoInfo.json` 中的 `groupTitle` 和 `title`，生成可读文件名  
- ✅ **批量处理**：自动遍历所有纯数字命名的文件夹（如 `880321710/`）
- ✅ **失败汇总**：处理完成后提示哪些视频未成功转换
- ✅ **即开即用**：无需安装，仅依赖 Python 和 FFmpeg

---

## 📁 目录结构要求
```
input/                     ← 缓存目录/自定义目录
└── xxx/                   ← 数字名文件夹
    ├── xxx-1-30120.m4s    ← 视频
    ├── xxx-1-30280.m4s    ← 音频
    ├── videoInfo.json     ← 视频元数据
    └── ...                ← 其他文件
any_folder/
├── run.py                 ← 本脚本
├── output/                ← 自动生成，存放合并后的 MP4
└── temp/                  ← 自动生成，临时文件（处理完自动删除）
```

> 💡 `input/` 目录可通过以下方式获取：
> - UWP 缓存路径通常为：`C:\Users\~\Videos\bilibili`
> - 也可以将需要处理的视频文件夹**复制到本项目的 `input/` 中**

---

## ⚙️ 使用步骤

### 1. 安装依赖
- **FFmpeg**（须加入系统 PATH）
  - 安装后，在 CMD 中运行 `ffmpeg -version`，若显示版本即成功

### 2. 配置并运行脚本
请编辑脚本开头部分以匹配你的文件路径：
```python
input_dir = Path("input")                # 目标目录
output_dir = Path("output")              # 输出目录（自动创建）
temp_dir = Path("temp")                  # 临时目录（自动创建）
```
> 🔔 使用原始字符串 `r"..."` 避免 Windows 路径转义问题
> 💡 原始缓存文件始终只读，处理过程在 `temp/` 中进行，结束后自动清理
---

## 🙌 致谢
- 感谢B站提供的高清缓存功能（虽然要大会员）
- 强大的开源音视频处理工具 FFmpeg 
- 原理参考自社区对 B站 `.m4s` 伪加密机制的逆向分析：[参考专栏](https://www.bilibili.com/opus/1007838020456415272)
- 伟大的互联网分享精神！
